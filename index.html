<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Jerome’s Assault</title>
    <style>
        canvas {
            border: 1px solid black;
            display: block;
            margin: 0 auto;
            background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAJ0lEQVQYlWNgYGD4z8DA8P+fgeE/DQyM/yRg+P8PA8P/DQz/DwMAfH8mB2kF2RgAAAAASUVORK5CYII=') repeat; /* Tiled metal texture */
        }
        body {
            text-align: center;
            background: #111;
            color: white;
            font-family: Arial, sans-serif;
        }
        #upgrades {
            margin: 10px;
        }
        button {
            padding: 5px 10px;
            margin: 5px;
            background: #333;
            color: white;
            border: 1px solid #555;
            cursor: pointer;
        }
        button:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <h1>Jerome’s Assault</h1>
    <p>Score: <span id="score">0</span> | Round: <span id="round">1</span> | HP: <span id="health">100</span></p>
    <div id="upgrades">
        <button onclick="buyUpgrade('shotgun')">Shotgun (100)</button>
        <button onclick="buyUpgrade('rifle')">Rifle (500)</button>
        <button onclick="buyUpgrade('speed')">Speed Boost (300)</button>
        <button onclick="buyUpgrade('health')">Health Pack (200)</button>
    </div>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('score');
        const roundDisplay = document.getElementById('round');
        const healthDisplay = document.getElementById('health');
        const upgradesDiv = document.getElementById('upgrades');

        // Player object
        const player = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            radius: 20,
            speed: 5,
            hp: 100,
            bullets: [],
            weapon: { name: 'pistol', damage: 10, rate: 500, spread: 0, recoil: 2, shots: 1 },
            lastShot: 0,
            angle: 0,
            recoilOffset: { x: 0, y: 0 }
        };

        // Game state
        let enemies = [];
        let particles = [];
        let muzzleFlashes = [];
        let enemyBullets = []; // NEW: For enemy projectiles
        let powerUps = []; // NEW: For power-ups
        let stars = []; // NEW: Background stars
        let score = 0;
        let round = 1;
        let roundTime = 0;
        let roundTransitionTime = 0;
        let inTransition = false;
        let enemySpeed = 2;
        let spawnRate = 5000;

        // Initialize stars
        for (let i = 0; i < 50; i++) {
            stars.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                radius: Math.random() * 2,
                speed: Math.random() * 0.5 + 0.5
            });
        }

        // Input handling
        const keys = {};
        window.addEventListener('keydown', (e) => keys[e.key] = true);
        window.addEventListener('keyup', (e) => keys[e.key] = false);
        canvas.addEventListener('click', shoot);
        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            player.angle = Math.atan2(mouseY - player.y, mouseX - player.x);
        });

        // Bullet class
        class Bullet {
            constructor(x, y, dx, dy, spread) {
                this.x = x;
                this.y = y;
                this.dx = dx + (Math.random() - 0.5) * spread;
                this.dy = dy + (Math.random() - 0.5) * spread;
                this.radius = player.weapon.name === 'shotgun' ? 3 : 5;
                this.speed = player.weapon.name === 'rifle' ? 15 : 10;
                this.damage = player.weapon.damage;
            }
            update() {
                this.x += this.dx * this.speed;
                this.y += this.dy * this.speed;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = player.weapon.name === 'rifle' ? '#FFA500' : 'yellow';
                ctx.fill();
            }
        }

        // EnemyBullet class (NEW)
        class EnemyBullet {
            constructor(x, y, dx, dy) {
                this.x = x;
                this.y = y;
                this.dx = dx;
                this.dy = dy;
                this.speed = 5;
                this.radius = 4;
            }
            update() {
                this.x += this.dx * this.speed;
                this.y += this.dy * this.speed;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = 'red';
                ctx.fill();
            }
        }

        // Blood particle class
        class Particle {
            constructor(x, y, color = null) { // Modified: Optional color parameter
                this.x = x;
                this.y = y;
                this.radius = Math.random() * 3 + 1;
                this.dx = (Math.random() - 0.5) * 4;
                this.dy = (Math.random() - 0.5) * 4;
                this.life = 30;
                this.color = color || (Math.random() < 0.5 ? '#8B0000' : '#FF0000'); // Default to blood if no color
            }
            update() {
                this.x += this.dx;
                this.y += this.dy;
                this.life--;
                this.radius *= 0.95;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
            }
        }

        // Muzzle flash class
        class MuzzleFlash {
            constructor(x, y, angle) {
                this.x = x;
                this.y = y;
                this.angle = angle;
                this.life = 5;
            }
            update() {
                this.life--;
            }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(15, 5);
                ctx.lineTo(25, 0);
                ctx.lineTo(15, -5);
                ctx.fillStyle = 'rgba(255, 165, 0, ' + (this.life / 5) + ')';
                ctx.fill();
                ctx.restore();
            }
        }

        // Enemy class (Updated with AI)
        class Enemy {
            constructor(type) {
                const side = Math.floor(Math.random() * 4);
                if (side === 0) { this.x = Math.random() * canvas.width; this.y = -20; }
                else if (side === 1) { this.x = canvas.width + 20; this.y = Math.random() * canvas.height; }
                else if (side === 2) { this.x = Math.random() * canvas.width; this.y = canvas.height + 20; }
                else { this.x = -20; this.y = Math.random() * canvas.height; }

                this.type = type;
                this.speed = enemySpeed;
                this.angle = 0;

                if (type === 'militant') { // Small, fast
                    this.radius = 12;
                    this.hp = 1;
                    this.color = '#8B4513';
                    this.turbanColor = '#FFD700';
                } else if (type === 'warrior') { // Medium, agile, shoots
                    this.radius = 15;
                    this.speed *= 1.5;
                    this.hp = 2;
                    this.color = '#A0522D';
                    this.turbanColor = '#228B22';
                    this.shootCooldown = Math.random() * 2000 + 1000; // Shoots every 1-3s
                } else if (type === 'commander') { // Large, slow, spawns minions
                    this.radius = 20;
                    this.speed *= 0.7;
                    this.hp = 4;
                    this.color = '#2F4F4F';
                    this.turbanColor = '#800080';
                    this.spawnCooldown = 5000; // Spawns every 5s
                }
                this.knockback = { x: 0, y: 0 };
            }
            update() {
                const dx = player.x - this.x;
                const dy = player.y - this.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                this.angle = Math.atan2(dy, dx);

                // Commander stops at a distance
                let effectiveSpeed = this.speed;
                if (this.type === 'commander' && dist > 100) effectiveSpeed = 0;

                this.x += (dx / dist) * effectiveSpeed + this.knockback.x;
                this.y += (dy / dist) * effectiveSpeed + this.knockback.y;
                this.knockback.x *= 0.9;
                this.knockback.y *= 0.9;

                // Warrior shooting
                if (this.type === 'warrior' && Date.now() - (this.lastShot || 0) > this.shootCooldown) {
                    this.shoot();
                    this.lastShot = Date.now();
                }

                // Commander spawning
                if (this.type === 'commander' && Date.now() - (this.lastSpawn || 0) > this.spawnCooldown) {
                    this.spawnMinion();
                    this.lastSpawn = Date.now();
                }
            }
            shoot() {
                const dx = player.x - this.x;
                const dy = player.y - this.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                enemyBullets.push(new EnemyBullet(this.x, this.y, dx / dist, dy / dist));
            }
            spawnMinion() {
                enemies.push(new Enemy('militant'));
